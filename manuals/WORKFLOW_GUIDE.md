# Nexar Collision Prediction - Complete Workflow Guide

## Overview

This project uses **VideoMAE-Large** to predict collisions in dashcam videos. The workflow consists of:

1. **Data Processing** → Create balanced dataset from raw videos
2. **Training** → Train the VideoMAE model
3. **Prediction** → Generate predictions on validation/test data
4. **Analysis** → Evaluate model performance by scenario

---

## Project Structure

```
nexar-solution/
├── training/
│   ├── process.py              # Create balanced dataset
│   ├── train-large.py          # Train VideoMAE-Large (recommended)
│   └── train-giant.py          # Train VideoMAE-Giant (requires >24GB GPU)
├── prediction/
│   ├── predict_agg_from_val.py        # Predict on validation set
│   ├── predict_agg_from_train_val.py  # Predict on full dataset (train+val)
│   ├── predict_test-large.py          # Predict on test set (for submission)
│   ├── test_model-large.py            # Evaluate model metrics
│   └── ensemble_predict-large.py      # Ensemble multiple models
├── prediction_analysis/
│   └── scripts/                # Analysis scripts for all predictions
├── prediction_analysis/visible_only/
│   └── scripts/                # Analysis excluding "target not visible" videos
├── accuracy_per_scenario_VAL/  # Scenario accuracy (validation only)
├── accuracy_per_scenario_ALL/  # Scenario accuracy (full dataset)
├── video_predictions_VAL/      # Prediction outputs (validation)
├── video_predictions_ALL/      # Prediction outputs (full dataset)
├── balanced_dataset_2s/        # Processed training data
├── dataset/                    # Raw dataset (train.csv, test.csv, videos)
└── scenario_labels/            # Human annotations for scenarios
```

---

## Step 1: Data Processing

Converts raw videos into 2-second segments with balanced positive/negative samples.

```bash
cd /home/sra2157/git/nexar-solution
python training/process.py
```

**Input:** `dataset/train/` (raw videos), `dataset/train.csv` (labels)  
**Output:** `balanced_dataset_2s/train/` and `balanced_dataset_2s/val/`

---

## Step 2: Training

### Train VideoMAE-Large (Recommended)

Fits on GPUs with 10-11GB VRAM (e.g., RTX 3080).

```bash
python training/train-large.py
```

**Key Settings (in script):**
- `batch_size = 4`
- `accumulation_steps = 8` (effective batch = 32)
- `learning_rate = 1e-5`
- `epochs = 10`

**Output:** `best_videomaev2_large_focal.pth` (~1.5GB)

### Train VideoMAE-Giant (Optional)

Requires >24GB GPU (A100, H100).

```bash
python training/train-giant.py
```

**Output:** `best_videomaev2_giant.pth` (~12GB)

---

## Step 3: Generate Predictions

### Option A: Validation Set Only (Unbiased Evaluation)

```bash
python prediction/predict_agg_from_val.py
```

**Output:** `video_predictions_VAL/aggregated_predictions_any.csv`  
- ~293 videos
- Use for unbiased model evaluation

### Option B: Full Dataset (Better Statistics)

```bash
python prediction/predict_agg_from_train_val.py
```

**Output:** `video_predictions_ALL/aggregated_predictions_any.csv`  
- ~1477 videos (includes training data)
- Use for per-scenario statistics (larger sample sizes)
- ⚠️ Accuracy is biased/inflated due to training data

### Option C: Test Set (For Submission)

```bash
python prediction/predict_test-large.py
```

**Output:** `predictions.csv` (format: `id,score`)

---

## Step 4: Analysis

### 4.1 Run Full Prediction Analysis

Generates wrong/correct predictions, time difference analysis, scenario distributions.

```bash
python prediction_analysis/scripts/run_all_analyses.py --dataset BOTH
```

**Outputs:**
- `prediction_analysis/VAL/` - Validation results
- `prediction_analysis/ALL/` - Full dataset results
- CSVs: true_positives.csv, false_negatives.csv, etc.
- Plots: time_difference_analysis.png, confusion_matrix.png, etc.

### 4.2 Run "Visible Only" Analysis

Excludes videos where target is not visible (more meaningful accuracy).

```bash
python prediction_analysis/visible_only/scripts/run_all_analyses.py --dataset BOTH
```

**Filtering:**
- Excludes 125 videos where "Target not visible" = True in ANY round
- 624 remaining videos with visible targets

**Outputs:**
- `prediction_analysis/visible_only/VAL/` - Validation (129 videos, ~94.6% accuracy)
- `prediction_analysis/visible_only/ALL/` - Full dataset (624 videos, ~97.6% accuracy)

### 4.3 Accuracy Per Scenario

Already generated by `run_all_analyses.py`, but can run standalone:

```bash
python prediction_analysis/scripts/accuracy_by_scenario.py --dataset ALL
```

**Output:** `accuracy_per_scenario_ALL/`
- accuracy_level1.png/pdf
- accuracy_level2.png/pdf
- confusion_matrix.png/pdf
- accuracy_report.txt

---

## Quick Reference

### Complete Pipeline (One-Shot)

```bash
# 1. Process data (if not done)
python training/process.py

# 2. Train model
python training/train-large.py

# 3. Generate predictions
python prediction/predict_agg_from_val.py
python prediction/predict_agg_from_train_val.py

# 4. Run all analyses
python prediction_analysis/scripts/run_all_analyses.py --dataset BOTH
python prediction_analysis/visible_only/scripts/run_all_analyses.py --dataset BOTH
```

### Key Output Files

| File | Description |
|------|-------------|
| `best_videomaev2_large_focal.pth` | Trained model weights |
| `video_predictions_VAL/aggregated_predictions_any.csv` | Validation predictions |
| `video_predictions_ALL/aggregated_predictions_any.csv` | Full dataset predictions |
| `accuracy_per_scenario_*/accuracy_report.txt` | Per-scenario accuracy breakdown |
| `prediction_analysis*/*/wrong_predictions/false_negatives.csv` | Missed collision videos |

### Model Performance Summary

| Dataset | Videos | Accuracy | Notes |
|---------|--------|----------|-------|
| VAL (all) | 293 | ~91% | Unbiased |
| VAL (visible only) | 129 | ~94.6% | Excludes not-visible |
| ALL (all) | 1477 | ~96% | Biased (includes train) |
| ALL (visible only) | 624 | ~97.6% | Best for scenario analysis |

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| CUDA OOM | Reduce `batch_size` in training script |
| Missing predictions | Run predict_agg_from_*.py first |
| Low accuracy on scenario | Check sample size in accuracy_report.txt |
| Package errors | `pip install -r requirements.txt` |
